name: Feature Extraction With Testing Dataset

on:
  schedule:
    - cron: "30 22 * * *" # 22:30 UTC = 23:30 Lagos (WAT)
  workflow_dispatch:

jobs:
  extract-features:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.MTECH }} # âœ… Use your PAT here

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify aiohttp installation (debug)
        run: |
          pip show aiohttp || (echo "aiohttp not installed!" && exit 1)

      - name: Create HTTP Status Output Directory
        run: mkdir -p http_status

      - name: Run HTTP Status for PhiUSIIL Cleaned Data
        run: |
          python http_status_checker.py --input-file cleaned_data/PhiUSIIL_cleaned_v2.csv --output-dir http_status
        continue-on-error: true

      - name: Run HTTP Status for Mendeley Cleaned Data
        run: |
          python http_status_checker.py --input-file cleaned_data/Mendeley_cleaned_v2.csv --output-dir http_status
        continue-on-error: true

      - name: Run Lexical Feature Extraction
        run: |
          python lexical_feature_extractor.py

      - name: Upload HTTP Status Features
        uses: actions/upload-artifact@v4
        with:
          name: http_status_features
          path: http_status/

      - name: Upload Lexical Features
        uses: actions/upload-artifact@v4
        with:
          name: lexical_features
          path: lexical_features/

      - name: Commit and push feature files
        run: |
          git config user.name "Ifeoluwa Oseni"
          git config user.email "ifeoseni@gmail.com"
          git add http_status/ lexical_features/ || echo "Nothing to add"
          git diff --cached --quiet || git commit -m "Daily auto-update: feature extraction"
          git push origin main
